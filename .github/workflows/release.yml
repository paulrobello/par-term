name: Release and Deploy

# This workflow handles the complete release process:
# 1. Builds standalone binaries for multiple platforms (in parallel)
# 2. Publishes the library to crates.io
# 3. Creates a GitHub release with all binary artifacts
# 4. Updates Homebrew cask

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  RUST_VERSION: "1.85.0"

jobs:
  # Preflight checks - verify Cargo.toml is ready for release
  preflight-checks:
    name: Preflight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Verify par-term-emu-core-rust is not a path dependency
        run: |
          echo "Checking for par-term-emu-core-rust path dependency..."

          if grep -E 'par-term-emu-core-rust.*path\s*=' Cargo.toml; then
            echo "::error::Cargo.toml contains a local path dependency for par-term-emu-core-rust"
            echo "::error::Please update to use the published crates.io version before releasing"
            exit 1
          fi

          echo "✓ Cargo.toml is ready for release"

  # Build Linux ARM64 using cross (parallel)
  build-linux-arm64:
    name: Build binary - Linux ARM64
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [preflight-checks]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-unknown-linux-gnu

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Get version
        run: |
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Build binary with cross
        run: cross build --release --target aarch64-unknown-linux-gnu

      - name: Prepare artifact
        run: |
          mkdir -p release-binaries
          cp target/aarch64-unknown-linux-gnu/release/par-term release-binaries/par-term-linux-aarch64

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-aarch64-unknown-linux-gnu
          path: release-binaries/par-term-linux-aarch64
          retention-days: 1

  # Build Linux x86_64 (parallel)
  build-linux-x86_64:
    name: Build binary - Linux x86_64
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [preflight-checks]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-gnu

      - name: Add Rust target (ensure installed)
        run: rustup target add x86_64-unknown-linux-gnu

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-dev libwayland-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libasound2-dev libgtk-3-dev libxdo-dev

      - name: Get version
        run: |
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Build binary
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Strip binary
        run: strip target/x86_64-unknown-linux-gnu/release/par-term

      - name: Prepare artifact
        run: |
          mkdir -p release-binaries
          cp target/x86_64-unknown-linux-gnu/release/par-term release-binaries/par-term-linux-x86_64

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-x86_64-unknown-linux-gnu
          path: release-binaries/par-term-linux-x86_64
          retention-days: 1

  # Build Windows x86_64 (parallel)
  build-windows-x86_64:
    name: Build binary - Windows x86_64
    runs-on: windows-latest
    timeout-minutes: 30
    needs: [preflight-checks]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-msvc

      - name: Add Rust target (ensure installed)
        run: rustup target add x86_64-pc-windows-msvc

      - name: Get version
        shell: bash
        run: |
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Build binary
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p release-binaries
          cp target/x86_64-pc-windows-msvc/release/par-term.exe release-binaries/par-term-windows-x86_64.exe

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-x86_64-pc-windows-msvc
          path: release-binaries/par-term-windows-x86_64.exe
          retention-days: 1

  # Build macOS x86_64 (parallel)
  build-macos-x86_64:
    name: Build binary - macOS x86_64
    runs-on: macos-latest
    timeout-minutes: 20
    needs: [preflight-checks]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-apple-darwin

      - name: Add Rust target (ensure installed)
        run: rustup target add x86_64-apple-darwin

      - name: Get version
        run: |
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Build binary
        run: cargo build --release --target x86_64-apple-darwin

      - name: Bundle and Zip
        run: |
          mkdir -p par-term.app/Contents/MacOS
          mkdir -p par-term.app/Contents/Resources

          # Copy binary
          cp target/x86_64-apple-darwin/release/par-term par-term.app/Contents/MacOS/par-term
          chmod +x par-term.app/Contents/MacOS/par-term

          # Copy icon
          cp assets/par-term.icns par-term.app/Contents/Resources/

          # Create Info.plist
          cat <<EOF > par-term.app/Contents/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>par-term</string>
              <key>CFBundleIconFile</key>
              <string>par-term.icns</string>
              <key>CFBundleIdentifier</key>
              <string>com.paulrobello.par-term</string>
              <key>CFBundleName</key>
              <string>par-term</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.13</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Create zip
          zip -r par-term-macos-x86_64.zip par-term.app

          mkdir -p release-binaries
          mv par-term-macos-x86_64.zip release-binaries/

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-x86_64-apple-darwin
          path: release-binaries/par-term-macos-x86_64.zip
          retention-days: 1

  # Build macOS ARM64 (parallel)
  build-macos-arm64:
    name: Build binary - macOS ARM64
    runs-on: macos-latest
    timeout-minutes: 35
    needs: [preflight-checks]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-darwin

      - name: Add Rust target (ensure installed)
        run: rustup target add aarch64-apple-darwin

      - name: Get version
        run: |
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Build binary
        run: cargo build --release --target aarch64-apple-darwin

      - name: Bundle and Zip
        run: |
          mkdir -p par-term.app/Contents/MacOS
          mkdir -p par-term.app/Contents/Resources

          # Copy binary
          cp target/aarch64-apple-darwin/release/par-term par-term.app/Contents/MacOS/par-term
          chmod +x par-term.app/Contents/MacOS/par-term

          # Copy icon
          cp assets/par-term.icns par-term.app/Contents/Resources/

          # Create Info.plist
          cat <<EOF > par-term.app/Contents/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>par-term</string>
              <key>CFBundleIconFile</key>
              <string>par-term.icns</string>
              <key>CFBundleIdentifier</key>
              <string>com.paulrobello.par-term</string>
              <key>CFBundleName</key>
              <string>par-term</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.13</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Create zip
          zip -r par-term-macos-aarch64.zip par-term.app

          mkdir -p release-binaries
          mv par-term-macos-aarch64.zip release-binaries/

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-aarch64-apple-darwin
          path: release-binaries/par-term-macos-aarch64.zip
          retention-days: 1

  # Publish to crates.io (after all builds complete)
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-linux-arm64, build-linux-x86_64, build-windows-x86_64, build-macos-x86_64, build-macos-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-dev libwayland-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libasound2-dev libgtk-3-dev libxdo-dev

      - name: Get version
        id: version
        run: |
          CARGO_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name == "par-term") | .version')
          echo "version=$CARGO_VERSION" >> "$GITHUB_OUTPUT"
          echo "Cargo.toml version: $CARGO_VERSION"

      - name: Run tests
        run: cargo test --verbose

      - name: Publish workspace subcrates (Layer 1 - no workspace deps)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          publish_if_needed() {
            local crate=$1
            local version
            version=$(cargo metadata --format-version 1 --no-deps | jq -r --arg c "$crate" '.packages[] | select(.name == $c) | .version')

            local http_status
            http_status=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://crates.io/api/v1/crates/$crate/$version" \
              -H "User-Agent: par-term-ci-publish")

            if [ "$http_status" = "200" ]; then
              echo "✓ $crate $version already on crates.io, skipping"
            else
              echo "Publishing $crate $version..."
              cargo publish -p "$crate" --token "$CARGO_REGISTRY_TOKEN"
            fi
          }

          publish_if_needed par-term-acp
          publish_if_needed par-term-config
          publish_if_needed par-term-mcp
          publish_if_needed par-term-ssh

      - name: Wait for Layer 1 indexing
        run: |
          echo "Waiting 60s for crates.io to index Layer 1 crates..."
          sleep 60

      - name: Publish workspace subcrates (Layer 2 - depend on par-term-config)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          publish_if_needed() {
            local crate=$1
            local version
            version=$(cargo metadata --format-version 1 --no-deps | jq -r --arg c "$crate" '.packages[] | select(.name == $c) | .version')

            local http_status
            http_status=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://crates.io/api/v1/crates/$crate/$version" \
              -H "User-Agent: par-term-ci-publish")

            if [ "$http_status" = "200" ]; then
              echo "✓ $crate $version already on crates.io, skipping"
            else
              echo "Publishing $crate $version..."
              cargo publish -p "$crate" --token "$CARGO_REGISTRY_TOKEN"
            fi
          }

          publish_if_needed par-term-fonts
          publish_if_needed par-term-input
          publish_if_needed par-term-keybindings
          publish_if_needed par-term-scripting
          publish_if_needed par-term-settings-ui
          publish_if_needed par-term-terminal
          publish_if_needed par-term-tmux
          publish_if_needed par-term-update

      - name: Wait for Layer 2 indexing
        run: |
          echo "Waiting 60s for crates.io to index Layer 2 crates..."
          sleep 60

      - name: Publish workspace subcrates (Layer 3 - depend on par-term-fonts)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          publish_if_needed() {
            local crate=$1
            local version
            version=$(cargo metadata --format-version 1 --no-deps | jq -r --arg c "$crate" '.packages[] | select(.name == $c) | .version')

            local http_status
            http_status=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://crates.io/api/v1/crates/$crate/$version" \
              -H "User-Agent: par-term-ci-publish")

            if [ "$http_status" = "200" ]; then
              echo "✓ $crate $version already on crates.io, skipping"
            else
              echo "Publishing $crate $version..."
              cargo publish -p "$crate" --token "$CARGO_REGISTRY_TOKEN"
            fi
          }

          publish_if_needed par-term-render

      - name: Wait for Layer 3 indexing
        run: |
          echo "Waiting 60s for crates.io to index Layer 3 crates..."
          sleep 60

      - name: Dry run publish par-term
        run: cargo publish --dry-run -p par-term

      - name: Publish par-term to crates.io
        run: cargo publish -p par-term --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Version may already exist on crates.io, continuing..."
        continue-on-error: true
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: Ilshidur/action-discord@master
        with:
          args: 'Published {{ EVENT_PAYLOAD.repository.name }} v${{ steps.version.outputs.version }} to crates.io successfully!'
        continue-on-error: true

  # Create GitHub release (after all builds complete)
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-linux-arm64, build-linux-x86_64, build-windows-x86_64, build-macos-x86_64, build-macos-arm64]
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Get version
        id: get_version
        run: |
          version=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[0].version')
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Package version: $version"

      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: binaries
          merge-multiple: true

      - name: Create shaders archive
        run: |
          zip -r binaries/shaders.zip shaders/ -x "*.DS_Store"
          echo "Created shaders.zip with contents:"
          unzip -l binaries/shaders.zip | tail -20

      - name: List downloaded binaries
        run: ls -lh binaries/

      - name: Create or update GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          VERSION="v${{ steps.get_version.outputs.version }}"

          # Check if release exists
          if gh release view "$VERSION" --repo '${{ github.repository }}' >/dev/null 2>&1; then
            echo "Release $VERSION already exists. Deleting and recreating..."
            gh release delete "$VERSION" --repo '${{ github.repository }}' --yes
          fi

          # Create new release
          gh release create \
          "$VERSION" \
          --repo '${{ github.repository }}' \
          --generate-notes \
          --latest

      - name: Upload binaries to GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release upload \
          'v${{ steps.get_version.outputs.version }}' binaries/* \
          --repo '${{ github.repository }}' \
          --clobber

    outputs:
      version: ${{ steps.get_version.outputs.version }}

  publish-homebrew-cask:
    name: Publish Homebrew Cask
    needs: [github-release]
    uses: ./.github/workflows/publish-homebrew-cask-core.yml
    with:
      version: ${{ needs.github-release.outputs.version }}
    secrets: inherit
