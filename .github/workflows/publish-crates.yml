name: Publish to crates.io

# Standalone workflow for publishing to crates.io
# This can be triggered independently of the full release process
# Useful for republishing or fixing crates.io releases without rebuilding everything

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip running tests (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Verify par-term-emu-core-rust is not a path dependency
        run: |
          echo "Checking for par-term-emu-core-rust path dependency in all Cargo.toml files..."

          FOUND=0
          for toml in Cargo.toml par-term-*/Cargo.toml; do
            if grep -E 'par-term-emu-core-rust.*path\s*=' "$toml"; then
              echo "::error::$toml contains a local path dependency for par-term-emu-core-rust"
              FOUND=1
            fi
          done

          if [ "$FOUND" -eq 1 ]; then
            echo "::error::Please update to use the published crates.io version before releasing"
            exit 1
          fi

          echo "✓ All Cargo.toml files are ready for publish"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.0

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-dev libwayland-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libasound2-dev libgtk-3-dev libxdo-dev

      - name: Get version and build version map
        id: version
        run: |
          CARGO_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name == "par-term") | .version')
          echo "version=$CARGO_VERSION" >> "$GITHUB_OUTPUT"
          echo "Cargo.toml version: $CARGO_VERSION"

          # Build version map once for all publish steps
          cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | "\(.name)=\(.version)"' > /tmp/crate-versions.txt
          echo "Crate versions:"
          cat /tmp/crate-versions.txt

      - name: Check if par-term version exists on crates.io
        id: check_version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Checking if par-term $VERSION exists on crates.io..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://crates.io/api/v1/crates/par-term/$VERSION" \
            -H "User-Agent: par-term-ci-publish")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Warning: Version $VERSION already exists on crates.io"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Version $VERSION not found on crates.io, proceeding with publish"
          fi

      - name: Run tests
        if: ${{ !inputs.skip_tests && steps.check_version.outputs.exists == 'false' }}
        run: cargo test --verbose

      - name: Publish all crates in dependency order
        if: steps.check_version.outputs.exists == 'false'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          get_version() {
            grep "^${1}=" /tmp/crate-versions.txt | cut -d= -f2
          }

          wait_for_crate() {
            local crate=$1 version=$2
            echo "Waiting for $crate $version to be indexed..."
            for i in $(seq 1 24); do
              local http_status
              http_status=$(curl -s -o /dev/null -w "%{http_code}" \
                "https://crates.io/api/v1/crates/$crate/$version" \
                -H "User-Agent: par-term-ci-publish")
              if [ "$http_status" = "200" ]; then
                echo "✓ $crate $version indexed after $((i * 5))s"
                return 0
              fi
              sleep 5
            done
            echo "⚠ $crate $version not indexed after 120s, proceeding anyway"
          }

          publish_if_needed() {
            local crate=$1
            local version
            version=$(get_version "$crate")

            local http_status
            http_status=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://crates.io/api/v1/crates/$crate/$version" \
              -H "User-Agent: par-term-ci-publish")

            if [ "$http_status" = "200" ]; then
              echo "✓ $crate $version already on crates.io, skipping"
            else
              echo "Publishing $crate $version..."
              cargo publish -p "$crate" --no-verify --token "$CARGO_REGISTRY_TOKEN"
              PUBLISHED_CRATES+=("$crate=$version")
            fi
          }

          PUBLISHED_CRATES=()

          # Layer 0+1: no workspace deps
          echo "=== Layer 0+1: Independent crates ==="
          publish_if_needed par-term-acp
          publish_if_needed par-term-config
          publish_if_needed par-term-mcp
          publish_if_needed par-term-ssh

          # Wait only for crates that were actually published
          for entry in "${PUBLISHED_CRATES[@]}"; do
            wait_for_crate "${entry%%=*}" "${entry#*=}"
          done
          PUBLISHED_CRATES=()

          # Layer 2: depend on par-term-config
          echo "=== Layer 2: Config-dependent crates ==="
          publish_if_needed par-term-fonts
          publish_if_needed par-term-input
          publish_if_needed par-term-keybindings
          publish_if_needed par-term-scripting
          publish_if_needed par-term-settings-ui
          publish_if_needed par-term-terminal
          publish_if_needed par-term-tmux
          publish_if_needed par-term-update

          for entry in "${PUBLISHED_CRATES[@]}"; do
            wait_for_crate "${entry%%=*}" "${entry#*=}"
          done
          PUBLISHED_CRATES=()

          # Layer 3: depend on par-term-fonts
          echo "=== Layer 3: Render crate ==="
          publish_if_needed par-term-render

          for entry in "${PUBLISHED_CRATES[@]}"; do
            wait_for_crate "${entry%%=*}" "${entry#*=}"
          done

          # Layer 4: root crate
          echo "=== Layer 4: Root crate ==="
          publish_if_needed par-term

      - name: Version already exists
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "::notice::Version ${{ steps.version.outputs.version }} already exists on crates.io. Skipping publish."

      - name: Discord notification
        if: success() && steps.check_version.outputs.exists == 'false'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: Ilshidur/action-discord@master
        with:
          args: 'Published {{ EVENT_PAYLOAD.repository.name }} v${{ steps.version.outputs.version }} to crates.io successfully!'
        continue-on-error: true
