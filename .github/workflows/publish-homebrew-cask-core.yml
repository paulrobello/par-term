name: Publish Homebrew Cask (core)

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

jobs:
  update-and-publish-cask:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ inputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release assets
        run: |
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"
          ASSET_INTEL="par-term-macos-x86_64.zip"
          ASSET_ARM="par-term-macos-aarch64.zip"

          echo "Downloading Intel asset: $ASSET_INTEL"
          curl -f -L -o "$ASSET_INTEL" "$BASE_URL/$ASSET_INTEL"

          echo "Downloading ARM asset: $ASSET_ARM"
          curl -f -L -o "$ASSET_ARM" "$BASE_URL/$ASSET_ARM"

      - name: Calculate SHA256
        id: sha256_calc
        run: |
          SHA256_INTEL=$(shasum -a 256 "par-term-macos-x86_64.zip" | awk '{print $1}')
          SHA256_ARM=$(shasum -a 256 "par-term-macos-aarch64.zip" | awk '{print $1}')

          echo "sha256_intel=$SHA256_INTEL" >> "$GITHUB_OUTPUT"
          echo "sha256_arm=$SHA256_ARM" >> "$GITHUB_OUTPUT"

      - name: Update Cask file
        env:
          CASK_FILE: homebrew/Casks/par-term.rb
          SHA_INTEL: ${{ steps.sha256_calc.outputs.sha256_intel }}
          SHA_ARM: ${{ steps.sha256_calc.outputs.sha256_arm }}
        run: |
          cat > "$CASK_FILE" <<'EOF'
          cask "par-term" do
            arch arm: "aarch64", intel: "x86_64"

            version "__VERSION__"
            sha256 arm:   "__SHA_ARM__",
                   intel: "__SHA_INTEL__"

            url "https://github.com/paulrobello/par-term/releases/download/v#{version}/par-term-macos-#{arch}.zip"
            name "par-term"
            desc "Cross-platform GPU-accelerated terminal emulator with inline graphics support"
            homepage "https://github.com/paulrobello/par-term"

            depends_on macos: ">= :catalina"

            livecheck do
              url :homepage
              strategy :github_latest
            end

            app "par-term.app"

            zap trash: [
              "~/Library/Application Support/par-term",
              "~/Library/Preferences/com.paulrobello.par-term.plist",
              "~/Library/Saved Application State/com.paulrobello.par-term.savedState",
              "~/.config/par-term",
            ]
          end
          EOF

          sed -i "s/__VERSION__/${VERSION}/" "$CASK_FILE"
          sed -i "s/__SHA_INTEL__/${SHA_INTEL}/" "$CASK_FILE"
          sed -i "s/__SHA_ARM__/${SHA_ARM}/" "$CASK_FILE"
          cat "$CASK_FILE"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push to Source Repo
        run: |
          git add homebrew/Casks/par-term.rb
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update par-term cask to v${VERSION}"
            git fetch origin main
            git rebase origin/main
            git push origin HEAD:main
          fi

      - name: Sync Homebrew tap repository
        env:
          TAP_REPO: paulrobello/homebrew-par-term
          TAP_BRANCH: main
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "$TAP_TOKEN" ]; then
            echo "HOMEBREW_TAP_TOKEN secret must be set to push to $TAP_REPO" >&2
            exit 1
          fi

          TAP_DIR="$(mktemp -d)"
          git clone --depth 1 "https://${TAP_TOKEN}@github.com/${TAP_REPO}.git" "$TAP_DIR"

          mkdir -p "$TAP_DIR/Casks"
          cp homebrew/Casks/par-term.rb "$TAP_DIR/Casks/par-term.rb"

          (
            cd "$TAP_DIR" || exit 1
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add Casks/par-term.rb
            if git diff --cached --quiet; then
              echo "Tap already up-to-date; skipping commit."
            else
              git commit -m "Update par-term cask to v${VERSION}"
              git push origin "$TAP_BRANCH"
            fi
          )
